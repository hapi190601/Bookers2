<main>
  <div class="container">
    <div class="row">
      <div class="col-md-3">
        <%= render 'users/template', book: @book_new , user: @user %>
      </div>

      <div class="col-md-8 offset-md-1">
        <h2>Book detail</h2>

        <table class="table">
          <tbody>
            <tr>
              <td>
                <%= link_to user_path(@user.id) do %>
                  <%= attachment_image_tag @user, :profile_image, :fill, 40, 40, fallback: "no_image.jpg" , size:"40x40" %>
                  <br>
                  <%= @user.name %>
                <% end %>
              </td>

              <td><%= link_to @book.title , book_path(@book.id) %></td>
              <td><%= @book.body %></td>

              <!--いいね機能-->
              <% if @book.favorited_by?(current_user) %>
              <td>
                <%= link_to book_favorites_path(@book), method: :delete do %>
                  ♥<%= @book.favorites.count %>いいね
                <% end %>
              </td>
              <% else %>
              <td>
                <%= link_to book_favorites_path(@book), method: :post do %>
                  ♡<%= @book.favorites.count %>いいね
                <% end %>
              <% end %>
              </td>

              <td>
                <p>コメント数：<%= @book.book_comments.count %></p>
              </td>

              <% if @book.user == current_user %>
              <td><%= link_to "Edit", edit_book_path , class:"btn btn-sm btn-success" %></td>
              <td><%= link_to "Destroy", book_path(@book.id), method: :delete , data: {confirm: "本当に消しますか？"} , class:"btn btn-sm btn-danger" %></td>
              <% end %>
            </tr>
          </tbody>
        </table>

        <!-- コメント機能-->
        <div class="comment-box">
          <!--コメント一覧-->
          <% @book.book_comments.each do |comment| %>
            <table class="table">
              <tbody>
                <tr>
                  <!--コメント者の写真と名前(リンク)-->
                  <td class="td">
                    <%= link_to user_path(comment.user_id) do %>
                      <%= attachment_image_tag comment.user.profile_image, :profile_image, :fill, 40, 40, fallback: "no_image.jpg" , size:"40x40" %>
                      <br>
                      <%= comment.user.name %>
                    <% end %>
                  </td>

                  <!--コメント内容-->
                  <td class="comment-space">
                    <%= comment.comment %>
                  </td>

                  <!--削除ボタン-->
                  <td clas="td">
                    <% if current_user.id == comment.user.id %>
                    <%= link_to "Destroy", book_book_comment_path(comment.book_id, comment), method: :delete, class:"btn btn-sm btn-danger" %>
                    <% end %>
                  </td>
                </tr>
              </tbody>
            </table>
          <% end %>

          <!--入力フォーム-->
          <%= form_with(model:[@book,@book_comment], local: true) do |f| %>
            <%= f.text_area :comment, rows:"5", class:"textarea-full" %>
            <%= f.submit "送信" ,class:"btn btn-sm btn-secondary" %>
          <% end %>
        </div>

      </div>
    </div>
  </div>
</main>




